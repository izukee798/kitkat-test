local espEnabled = false
local espObjects = {}

local function createESP(player)
    if espObjects[player] then return end -- already created

    local char = player.Character
    if not char then return end

    local hrp = char:FindFirstChild("HumanoidRootPart")
    local humanoid = char:FindFirstChildOfClass("Humanoid")
    if not hrp or not humanoid then return end

    -- Create a BillboardGui
    local billboardGui = Instance.new("BillboardGui")
    billboardGui.Name = "ESPBillboard"
    billboardGui.Adornee = hrp
    billboardGui.Size = UDim2.new(0, 150, 0, 50)
    billboardGui.AlwaysOnTop = true
    billboardGui.Parent = hrp

    -- Container Frame
    local frame = Instance.new("Frame")
    frame.BackgroundTransparency = 0.4
    frame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    frame.Size = UDim2.new(1, 0, 1, 0)
    frame.Parent = billboardGui

    -- Name Label
    local nameLabel = Instance.new("TextLabel")
    nameLabel.Size = UDim2.new(1, 0, 0.4, 0)
    nameLabel.BackgroundTransparency = 1
    nameLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    nameLabel.TextStrokeTransparency = 0
    nameLabel.Font = Enum.Font.SourceSansBold
    nameLabel.TextSize = 14
    nameLabel.Text = player.Name
    nameLabel.Parent = frame

    -- Health Bar Background
    local healthBarBg = Instance.new("Frame")
    healthBarBg.Size = UDim2.new(1, -10, 0.3, 0)
    healthBarBg.Position = UDim2.new(0, 5, 0.5, 0)
    healthBarBg.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
    healthBarBg.BackgroundTransparency = 0.6
    healthBarBg.BorderSizePixel = 0
    healthBarBg.Parent = frame

    -- Health Bar Foreground
    local healthBar = Instance.new("Frame")
    healthBar.Size = UDim2.new(humanoid.Health / humanoid.MaxHealth, 0, 1, 0)
    healthBar.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
    healthBar.BorderSizePixel = 0
    healthBar.Parent = healthBarBg

    -- Distance Label
    local distLabel = Instance.new("TextLabel")
    distLabel.Size = UDim2.new(1, 0, 0.3, 0)
    distLabel.Position = UDim2.new(0, 0, 0.8, 0)
    distLabel.BackgroundTransparency = 1
    distLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    distLabel.TextStrokeTransparency = 0.7
    distLabel.Font = Enum.Font.SourceSans
    distLabel.TextSize = 12
    distLabel.Text = "Distance: 0"
    distLabel.Parent = frame

    espObjects[player] = {
        Billboard = billboardGui,
        HealthBar = healthBar,
        HealthBarBg = healthBarBg,
        DistanceLabel = distLabel,
        Humanoid = humanoid,
        HRP = hrp,
    }
end

local function removeESP(player)
    if espObjects[player] then
        espObjects[player].Billboard:Destroy()
        espObjects[player] = nil
    end
end

local function updateESP()
    for player, esp in pairs(espObjects) do
        local humanoid = esp.Humanoid
        if humanoid and humanoid.Parent then
            local healthPercent = math.clamp(humanoid.Health / humanoid.MaxHealth, 0, 1)
            esp.HealthBar.Size = UDim2.new(healthPercent, 0, 1, 0)

            local dist = (Player.Character and Player.Character:FindFirstChild("HumanoidRootPart") and
                (esp.HRP.Position - Player.Character.HumanoidRootPart.Position).Magnitude) or 0
            esp.DistanceLabel.Text = ("Distance: %.1f"):format(dist)
        else
            removeESP(player)
        end
    end
end

local function refreshESP()
    if not espEnabled then
        for player, _ in pairs(espObjects) do
            removeESP(player)
        end
        return
    end

    for _, player in pairs(Players:GetPlayers()) do
        if player ~= Player then
            if player.Character and player.Character:FindFirstChild("HumanoidRootPart") and player.Character:FindFirstChildOfClass("Humanoid") then
                if not espObjects[player] then
                    createESP(player)
                end
            else
                removeESP(player)
            end
        end
    end
end

Players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function()
        if espEnabled then
            refreshESP()
        end
    end)
end)

Players.PlayerRemoving:Connect(function(player)
    removeESP(player)
end)

RunService.RenderStepped:Connect(function()
    if espEnabled then
        updateESP()
    end
end)

Tab:CreateToggle({
    Name = "ESP",
    CurrentValue = false,
    Flag = "ESPToggle",
    Callback = function(state)
        espEnabled = state
        refreshESP()
    end,
})


